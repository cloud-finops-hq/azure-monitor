<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Cost Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e7;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            background: linear-gradient(90deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .timestamp {
            color: #71717a;
            font-size: 14px;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #4ade80;
            font-size: 12px;
        }

        .auto-refresh .dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .refresh-btn {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 14px;
            color: #a1a1aa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .card-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .card-change {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .positive { color: #4ade80; }
        .negative { color: #f87171; }
        .neutral { color: #71717a; }

        .icon-blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .icon-purple { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        .icon-green { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .icon-orange { background: rgba(249, 115, 22, 0.2); color: #fb923c; }
        .icon-red { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .icon-cyan { background: rgba(6, 182, 212, 0.2); color: #22d3ee; }

        /* Sponsorship Banner */
        .sponsorship-banner {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 24px;
        }

        .sponsorship-item {
            text-align: center;
        }

        .sponsorship-label {
            font-size: 12px;
            color: #a1a1aa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .sponsorship-value {
            font-size: 28px;
            font-weight: 700;
            color: #4ade80;
        }

        .sponsorship-value.warning {
            color: #facc15;
        }

        .sponsorship-note {
            font-size: 12px;
            color: #71717a;
            margin-top: 4px;
        }

        .countdown-bar {
            grid-column: 1 / -1;
            margin-top: 16px;
        }

        .countdown-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #71717a;
            margin-bottom: 8px;
        }

        .countdown-track {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .countdown-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22d3ee);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .table-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            color: #a1a1aa;
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            font-size: 14px;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .badge-green { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .badge-yellow { background: rgba(234, 179, 8, 0.2); color: #facc15; }
        .badge-red { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .badge-purple { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }

        .alert-banner {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-banner.warning {
            background: rgba(234, 179, 8, 0.1);
            border-color: rgba(234, 179, 8, 0.3);
        }

        .alert-banner .icon {
            font-size: 24px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            .sponsorship-banner {
                grid-template-columns: 1fr 1fr;
            }
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #71717a;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .token-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .token-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .cost-breakdown {
            display: flex;
            gap: 16px;
            margin-top: 16px;
        }

        .cost-item {
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }

        .cost-item-label {
            font-size: 11px;
            color: #71717a;
            margin-bottom: 4px;
        }

        .cost-item-value {
            font-size: 18px;
            font-weight: 600;
        }

        .next-refresh {
            font-size: 11px;
            color: #71717a;
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 16px;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #a1a1aa;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            background: rgba(255,255,255,0.1);
            color: #e4e4e7;
        }

        .tab.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            border-color: rgba(59, 130, 246, 0.5);
            color: #e4e4e7;
        }

        .tab.azure.active {
            background: linear-gradient(135deg, rgba(0, 120, 212, 0.2) 0%, rgba(0, 180, 240, 0.2) 100%);
            border-color: rgba(0, 120, 212, 0.5);
        }

        .tab.gcp.active {
            background: linear-gradient(135deg, rgba(234, 67, 53, 0.2) 0%, rgba(251, 188, 5, 0.2) 100%);
            border-color: rgba(234, 67, 53, 0.5);
        }

        .tab-icon {
            font-size: 18px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* GCP Specific Styles */
        .gcp-project-card {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .gcp-project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .gcp-project-name {
            font-weight: 600;
            font-size: 16px;
        }

        .gcp-project-id {
            font-size: 12px;
            color: #71717a;
        }

        .gcp-resources {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .gcp-resource-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            background: rgba(255,255,255,0.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Cloud Cost Dashboard</h1>
                <div class="timestamp" id="timestamp">Loading...</div>
            </div>
            <div class="header-info">
                <div class="auto-refresh">
                    <span class="dot"></span>
                    <span>Auto-refresh: <span id="next-refresh">--:--</span></span>
                </div>
                <button class="refresh-btn" id="refresh-btn" onclick="refreshData()">Refresh Now</button>
            </div>
        </header>

        <!-- Cloud Provider Tabs -->
        <div class="tabs">
            <div class="tab azure active" onclick="switchTab('azure')">
                <span class="tab-icon">‚òÅÔ∏è</span>
                <span>Azure</span>
            </div>
            <div class="tab gcp" onclick="switchTab('gcp')">
                <span class="tab-icon">üåê</span>
                <span>Google Cloud</span>
            </div>
        </div>

        <!-- Azure Tab Content -->
        <div id="azure-tab" class="tab-content active">

        <!-- Sponsorship Coverage Banner -->
        <div class="sponsorship-banner" id="sponsorship-banner">
            <div class="sponsorship-item">
                <div class="sponsorship-label">Sponsorship Status</div>
                <div class="sponsorship-value">Active</div>
                <div class="sponsorship-note">Microsoft Azure Sponsorship</div>
            </div>
            <div class="sponsorship-item">
                <div class="sponsorship-label">Days Remaining</div>
                <div class="sponsorship-value warning" id="days-remaining">--</div>
                <div class="sponsorship-note">Until April 2026</div>
            </div>
            <div class="sponsorship-item">
                <div class="sponsorship-label">Monthly Cost (Offset)</div>
                <div class="sponsorship-value" id="monthly-cost">$--</div>
                <div class="sponsorship-note">Currently $0 to pay</div>
            </div>
            <div class="sponsorship-item">
                <div class="sponsorship-label">Projected to April</div>
                <div class="sponsorship-value" id="projected-cost">$--</div>
                <div class="sponsorship-note">If usage continues</div>
            </div>
            <div class="countdown-bar">
                <div class="countdown-label">
                    <span>Sponsorship Progress</span>
                    <span id="sponsorship-end">Ends: April 30, 2026</span>
                </div>
                <div class="countdown-track">
                    <div class="countdown-fill" id="countdown-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div id="alerts"></div>

        <div class="grid" id="summary-cards">
            <div class="loading"><div class="spinner"></div></div>
        </div>

        <div class="grid-3">
            <div class="chart-container">
                <h3 class="chart-title">Daily Cost & Token Usage (Last 7 Days)</h3>
                <div class="chart-wrapper">
                    <canvas id="costChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">Cost by Account</h3>
                <div class="chart-wrapper">
                    <canvas id="accountChart"></canvas>
                </div>
            </div>
        </div>

        <div class="table-container">
            <h3 class="chart-title">OpenAI Accounts - Cost Breakdown</h3>
            <table>
                <thead>
                    <tr>
                        <th>Account</th>
                        <th>Model</th>
                        <th>Prompt Tokens (30d)</th>
                        <th>Completion Tokens</th>
                        <th>Est. Cost (30d)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="accounts-table">
                    <tr><td colspan="6" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="grid-2">
            <div class="table-container">
                <h3 class="chart-title">AI Services (Monitor for Claude)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Resource Group</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="aiservices-table">
                        <tr><td colspan="3" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="table-container">
                <h3 class="chart-title">Other Resources</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Resource Type</th>
                            <th>Count</th>
                            <th>Est. Monthly</th>
                        </tr>
                    </thead>
                    <tbody id="resources-table">
                        <tr><td colspan="3" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Cost Projection</h3>
            <p style="color: #71717a; margin-bottom: 16px;">
                These costs are currently <strong style="color: #4ade80;">offset by Microsoft Azure Sponsorship</strong>.
                After April 2026, you will need to pay these amounts.
            </p>
            <div class="cost-breakdown" id="cost-breakdown">
                <div class="cost-item">
                    <div class="cost-item-label">Azure OpenAI</div>
                    <div class="cost-item-value" id="openai-cost">$--</div>
                </div>
                <div class="cost-item">
                    <div class="cost-item-label">Storage</div>
                    <div class="cost-item-value" id="storage-cost">$--</div>
                </div>
                <div class="cost-item">
                    <div class="cost-item-label">Databases</div>
                    <div class="cost-item-value" id="db-cost">$--</div>
                </div>
                <div class="cost-item">
                    <div class="cost-item-label">Container Apps</div>
                    <div class="cost-item-value" id="container-cost">$--</div>
                </div>
                <div class="cost-item" style="background: rgba(34, 197, 94, 0.1);">
                    <div class="cost-item-label">Total Monthly</div>
                    <div class="cost-item-value" style="color: #4ade80;" id="total-monthly">$--</div>
                </div>
            </div>
        </div>

        <!-- Invoice History Section -->
        <div class="table-container" style="border: 1px solid rgba(239, 68, 68, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 class="chart-title" style="margin-bottom: 0;">Invoice History (Marketplace/Not Covered)</h3>
                <div style="display: flex; gap: 16px;">
                    <div style="text-align: right;">
                        <div style="font-size: 12px; color: #71717a;">Total Billed</div>
                        <div style="font-size: 24px; font-weight: 700; color: #f87171;" id="total-invoiced">¬£--</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 12px; color: #71717a;">Amount Due</div>
                        <div style="font-size: 24px; font-weight: 700; color: #facc15;" id="total-due">¬£--</div>
                    </div>
                </div>
            </div>
            <p style="color: #f87171; font-size: 13px; margin-bottom: 16px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                ‚ö†Ô∏è These are Azure Marketplace invoices (Anthropic/Claude) - <strong>NOT covered by Azure Sponsorship</strong>.
                Resources were deleted on Jan 9, 2026 to prevent future charges.
            </p>

            <!-- January Projection -->
            <div style="background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 14px; font-weight: 600; color: #facc15;">‚è≥ Pending: January 2026 (Projected)</div>
                        <div style="font-size: 12px; color: #71717a; margin-top: 4px;">
                            Usage from Jan 1-9 before Claude resources were deleted. Will appear on next invoice.
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 12px; color: #71717a;">Estimated</div>
                        <div style="font-size: 24px; font-weight: 700; color: #facc15;">~¬£330</div>
                        <div style="font-size: 11px; color: #71717a;">Based on Dec daily rate √ó 9 days</div>
                    </div>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Invoice ID</th>
                        <th>Period</th>
                        <th>Invoice Date</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="invoices-table">
                    <tr><td colspan="6" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        </div> <!-- End Azure Tab -->

        <!-- GCP Tab Content -->
        <div id="gcp-tab" class="tab-content">
            <div class="sponsorship-banner" style="background: linear-gradient(135deg, rgba(234, 67, 53, 0.1) 0%, rgba(251, 188, 5, 0.1) 100%); border-color: rgba(234, 67, 53, 0.3);">
                <div class="sponsorship-item">
                    <div class="sponsorship-label">Account</div>
                    <div class="sponsorship-value" id="gcp-account" style="color: #fb923c; font-size: 16px;">--</div>
                </div>
                <div class="sponsorship-item">
                    <div class="sponsorship-label">Projects</div>
                    <div class="sponsorship-value" id="gcp-projects" style="color: #fb923c;">--</div>
                </div>
                <div class="sponsorship-item">
                    <div class="sponsorship-label">Vertex AI</div>
                    <div class="sponsorship-value" id="gcp-vertex" style="color: #fb923c;">--</div>
                </div>
                <div class="sponsorship-item">
                    <div class="sponsorship-label">Storage Buckets</div>
                    <div class="sponsorship-value" id="gcp-buckets" style="color: #fb923c;">--</div>
                </div>
            </div>

            <div id="gcp-alerts"></div>

            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Total Projects</span>
                        <div class="card-icon" style="background: rgba(234, 67, 53, 0.2); color: #ea4335;">üìÅ</div>
                    </div>
                    <div class="card-value" id="gcp-total-projects">--</div>
                    <div class="card-change neutral">Across your GCP account</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Vertex AI Projects</span>
                        <div class="card-icon" style="background: rgba(66, 133, 244, 0.2); color: #4285f4;">ü§ñ</div>
                    </div>
                    <div class="card-value" id="gcp-vertex-count">--</div>
                    <div class="card-change neutral">With AI Platform enabled</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Compute Instances</span>
                        <div class="card-icon" style="background: rgba(251, 188, 5, 0.2); color: #fbbc05;">üíª</div>
                    </div>
                    <div class="card-value" id="gcp-compute-count">--</div>
                    <div class="card-change neutral">Running VMs</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Cloud Run Services</span>
                        <div class="card-icon" style="background: rgba(52, 168, 83, 0.2); color: #34a853;">üöÄ</div>
                    </div>
                    <div class="card-value" id="gcp-cloudrun-count">--</div>
                    <div class="card-change neutral">Serverless containers</div>
                </div>
            </div>

            <div class="table-container">
                <h3 class="chart-title">GCP Projects</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Project</th>
                            <th>Project ID</th>
                            <th>Billing</th>
                            <th>APIs</th>
                            <th>Resources</th>
                        </tr>
                    </thead>
                    <tbody id="gcp-projects-table">
                        <tr><td colspan="5" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">GCP Resource Overview</h3>
                <div class="chart-wrapper">
                    <canvas id="gcpChart"></canvas>
                </div>
            </div>
        </div> <!-- End GCP Tab -->

    </div>

    <script>
        let costChart = null;
        let accountChart = null;
        let gcpChart = null;
        let refreshInterval = null;
        let nextRefreshTime = null;
        const REFRESH_INTERVAL = 60 * 60 * 1000; // 1 hour in milliseconds

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`.tab.${tab}`).classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');

            if (tab === 'gcp') {
                loadGcpData();
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function formatCost(cost) {
            return '$' + parseFloat(cost || 0).toFixed(2);
        }

        function updateNextRefreshDisplay() {
            if (!nextRefreshTime) return;
            const now = Date.now();
            const remaining = Math.max(0, nextRefreshTime - now);
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            document.getElementById('next-refresh').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function renderSponsorshipBanner(data) {
            const sub = data.subscription || {};
            const costs = data.costs || {};

            document.getElementById('days-remaining').textContent = sub.daysRemaining || '--';
            document.getElementById('monthly-cost').textContent = formatCost(costs.totalMonthly);
            document.getElementById('projected-cost').textContent = formatCost(costs.projectedTillApril);

            // Calculate sponsorship progress (assuming started ~6 months ago)
            const totalDays = 365; // Approximate sponsorship duration
            const elapsed = totalDays - (sub.daysRemaining || 0);
            const progress = Math.min(100, Math.max(0, (elapsed / totalDays) * 100));
            document.getElementById('countdown-fill').style.width = progress + '%';
        }

        function renderSummaryCards(data) {
            const summary = data.summary || {};
            const costs = data.costs || {};
            const dailyMetrics = data.dailyMetrics || [];

            const today = dailyMetrics[dailyMetrics.length - 1]?.tokens || 0;
            const yesterday = dailyMetrics[dailyMetrics.length - 2]?.tokens || 0;
            const dailyChange = yesterday > 0 ? ((today - yesterday) / yesterday * 100).toFixed(1) : 0;
            const weeklyAvg = dailyMetrics.reduce((a, b) => a + (b.tokens || 0), 0) / 7;
            const dailyCostAvg = dailyMetrics.reduce((a, b) => a + parseFloat(b.cost || 0), 0) / 7;

            document.getElementById('summary-cards').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Total Tokens (30d)</span>
                        <div class="card-icon icon-blue">üìä</div>
                    </div>
                    <div class="card-value">${formatNumber(summary.totalTokens30d || 0)}</div>
                    <div class="card-change neutral">Across ${summary.openAiAccounts || 0} OpenAI accounts</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">OpenAI Cost (30d)</span>
                        <div class="card-icon icon-green">üí∞</div>
                    </div>
                    <div class="card-value">${formatCost(costs.openAi30d)}</div>
                    <div class="card-change positive">Offset by sponsorship</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Today's Usage</span>
                        <div class="card-icon icon-purple">üìà</div>
                    </div>
                    <div class="card-value">${formatNumber(today)}</div>
                    <div class="card-change ${parseFloat(dailyChange) >= 0 ? 'negative' : 'positive'}">
                        ${parseFloat(dailyChange) >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(dailyChange)}% vs yesterday
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Daily Avg Cost</span>
                        <div class="card-icon icon-cyan">üìÖ</div>
                    </div>
                    <div class="card-value">${formatCost(dailyCostAvg)}</div>
                    <div class="card-change neutral">~${formatCost(dailyCostAvg * 30)}/month</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">AI Services</span>
                        <div class="card-icon ${(summary.aiServicesAccounts || 0) > 0 ? 'icon-orange' : 'icon-green'}">‚ö†Ô∏è</div>
                    </div>
                    <div class="card-value">${summary.aiServicesAccounts || 0}</div>
                    <div class="card-change ${(summary.aiServicesAccounts || 0) > 0 ? 'negative' : 'positive'}">
                        ${(summary.aiServicesAccounts || 0) > 0 ? 'Monitor for Claude' : 'No Claude hosts'}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">SaaS Subscriptions</span>
                        <div class="card-icon ${(summary.saasSubscriptions || 0) > 0 ? 'icon-red' : 'icon-green'}">üõí</div>
                    </div>
                    <div class="card-value">${summary.saasSubscriptions || 0}</div>
                    <div class="card-change ${(summary.saasSubscriptions || 0) > 0 ? 'negative' : 'positive'}">
                        ${(summary.saasSubscriptions || 0) > 0 ? 'Marketplace billing!' : 'No marketplace charges'}
                    </div>
                </div>
            `;
        }

        function renderAlerts(data) {
            let alertsHtml = '';
            const alerts = data.alerts || {};

            if (alerts.hasSaasSubscriptions) {
                alertsHtml += `
                    <div class="alert-banner">
                        <span class="icon">üö®</span>
                        <div>
                            <strong>Active Marketplace Subscriptions Detected!</strong>
                            <p>You have SaaS subscriptions that are NOT covered by Azure Sponsorship credits.</p>
                        </div>
                    </div>
                `;
            }

            if (alerts.hasAiServices) {
                alertsHtml += `
                    <div class="alert-banner warning">
                        <span class="icon">‚ö†Ô∏è</span>
                        <div>
                            <strong>AI Services Resources Found</strong>
                            <p>These can host Claude models which incur Marketplace billing. Verify no Claude deployments exist.</p>
                        </div>
                    </div>
                `;
            }

            document.getElementById('alerts').innerHTML = alertsHtml;
        }

        function renderCostChart(data) {
            const ctx = document.getElementById('costChart').getContext('2d');
            const dailyMetrics = data.dailyMetrics || [];

            if (costChart) costChart.destroy();

            costChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dailyMetrics.map(d => d.date?.slice(5) || ''),
                    datasets: [
                        {
                            label: 'Tokens',
                            data: dailyMetrics.map(d => d.tokens || 0),
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            label: 'Cost ($)',
                            data: dailyMetrics.map(d => parseFloat(d.cost || 0)),
                            type: 'line',
                            borderColor: '#4ade80',
                            backgroundColor: 'rgba(74, 222, 128, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#4ade80',
                            yAxisID: 'y1',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#e4e4e7' }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#71717a' },
                            title: { display: true, text: 'Tokens', color: '#71717a' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            grid: { display: false },
                            ticks: { color: '#4ade80' },
                            title: { display: true, text: 'Cost ($)', color: '#4ade80' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#71717a' }
                        }
                    }
                }
            });
        }

        function renderAccountChart(data) {
            const ctx = document.getElementById('accountChart').getContext('2d');
            const accounts = data.openAiUsage || [];

            if (accountChart) accountChart.destroy();

            const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f97316', '#22c55e', '#eab308'];

            accountChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: accounts.map(a => a.account),
                    datasets: [{
                        data: accounts.map(a => parseFloat(a.estimatedCost30d || 0)),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e4e4e7', padding: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': $' + context.raw.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderAccountsTable(data) {
            const accounts = data.openAiUsage || [];
            const maxCost = Math.max(...accounts.map(a => parseFloat(a.estimatedCost30d || 0)));

            document.getElementById('accounts-table').innerHTML = accounts.map(a => {
                const cost = parseFloat(a.estimatedCost30d || 0);
                const barWidth = maxCost > 0 ? (cost / maxCost * 100) : 0;

                return `
                    <tr>
                        <td><strong>${a.account}</strong></td>
                        <td><span class="badge badge-purple">${a.primaryModel || 'N/A'}</span></td>
                        <td>${formatNumber(a.promptTokens30d || 0)}</td>
                        <td>${formatNumber(a.completionTokens30d || 0)}</td>
                        <td>
                            <span class="badge badge-green">${formatCost(cost)}</span>
                            <div class="token-bar"><div class="token-bar-fill" style="width: ${barWidth}%"></div></div>
                        </td>
                        <td><span class="badge badge-blue">Sponsored</span></td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="6" style="text-align: center;">No OpenAI accounts found</td></tr>';
        }

        function renderAiServicesTable(data) {
            const services = data.aiServices || [];

            if (services.length === 0) {
                document.getElementById('aiservices-table').innerHTML = `
                    <tr><td colspan="3" style="text-align: center; color: #4ade80;">‚úì No AI Services found</td></tr>
                `;
                return;
            }

            document.getElementById('aiservices-table').innerHTML = services.map(s => `
                <tr>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.resourceGroup}</td>
                    <td><span class="badge badge-yellow">Monitor</span></td>
                </tr>
            `).join('');
        }

        function renderResourcesTable(data) {
            const summary = data.summary || {};
            const costs = data.costs || {};

            const resources = [
                { type: 'Storage Accounts', count: summary.storageAccounts || 0, cost: (summary.storageAccounts || 0) * 0.2 },
                { type: 'PostgreSQL Servers', count: summary.postgresServers || 0, cost: (summary.postgresServers || 0) * 50 },
                { type: 'Container Apps', count: summary.containerApps || 0, cost: (summary.containerApps || 0) * 20 }
            ];

            document.getElementById('resources-table').innerHTML = resources.map(r => `
                <tr>
                    <td>${r.type}</td>
                    <td><span class="badge badge-blue">${r.count}</span></td>
                    <td><span class="badge badge-green">${formatCost(r.cost)}</span></td>
                </tr>
            `).join('');

            // Update cost breakdown
            document.getElementById('openai-cost').textContent = formatCost(costs.openAi30d);
            document.getElementById('storage-cost').textContent = formatCost((summary.storageAccounts || 0) * 0.2);
            document.getElementById('db-cost').textContent = formatCost((summary.postgresServers || 0) * 50);
            document.getElementById('container-cost').textContent = formatCost((summary.containerApps || 0) * 20);
            document.getElementById('total-monthly').textContent = formatCost(costs.totalMonthly);
        }

        function renderInvoicesTable(data) {
            const invoices = data.invoices || [];
            const summary = data.invoiceSummary || {};

            // Update totals
            document.getElementById('total-invoiced').textContent = '¬£' + (summary.totalInvoiced || 0).toFixed(2);
            document.getElementById('total-due').textContent = '¬£' + (summary.totalDue || 0).toFixed(2);

            if (invoices.length === 0) {
                document.getElementById('invoices-table').innerHTML = `
                    <tr><td colspan="6" style="text-align: center; color: #4ade80;">‚úì No marketplace invoices found</td></tr>
                `;
                return;
            }

            document.getElementById('invoices-table').innerHTML = invoices.map(inv => {
                const invoiceDate = new Date(inv.date).toLocaleDateString('en-GB');
                const periodStart = new Date(inv.periodStart).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
                const periodEnd = new Date(inv.periodEnd).toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
                const period = `${periodStart}`;

                const statusClass = inv.status === 'Due' ? 'badge-yellow' : 'badge-green';
                const statusIcon = inv.status === 'Due' ? '‚è≥' : '‚úì';

                const total = inv.total || inv.billedAmount || 0;
                const amountDue = inv.amountDue || 0;
                const displayAmount = inv.status === 'Due' ? amountDue : total;

                return `
                    <tr>
                        <td><strong>${inv.id}</strong></td>
                        <td>${period}</td>
                        <td>${invoiceDate}</td>
                        <td><span class="badge badge-red">${inv.type === 'AzureMarketplace' ? 'Marketplace' : inv.type}</span></td>
                        <td style="font-weight: 600; color: ${inv.status === 'Due' ? '#facc15' : '#e4e4e7'};">
                            ¬£${displayAmount.toFixed(2)}
                        </td>
                        <td><span class="badge ${statusClass}">${statusIcon} ${inv.status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // GCP Functions
        async function loadGcpData() {
            try {
                const response = await fetch('gcp-data.json?t=' + Date.now());
                const data = await response.json();

                renderGcpSummary(data);
                renderGcpProjects(data);
                renderGcpChart(data);
            } catch (error) {
                console.error('Error loading GCP data:', error);
                document.getElementById('gcp-projects-table').innerHTML = `
                    <tr><td colspan="5" style="text-align: center; color: #f87171;">
                        Error loading GCP data. Run <code>./collect-gcp-data.sh</code> first.
                    </td></tr>
                `;
            }
        }

        function renderGcpSummary(data) {
            const summary = data.summary || {};

            document.getElementById('gcp-account').textContent = data.account || '--';
            document.getElementById('gcp-projects').textContent = summary.totalProjects || 0;
            document.getElementById('gcp-vertex').textContent = summary.vertexAiProjects || 0;
            document.getElementById('gcp-buckets').textContent = summary.storageBuckets || 0;

            document.getElementById('gcp-total-projects').textContent = summary.totalProjects || 0;
            document.getElementById('gcp-vertex-count').textContent = summary.vertexAiProjects || 0;
            document.getElementById('gcp-compute-count').textContent = summary.computeInstances || 0;
            document.getElementById('gcp-cloudrun-count').textContent = summary.cloudRunServices || 0;

            // Alerts
            let alertsHtml = '';
            if (data.alerts?.hasVertexAi) {
                alertsHtml += `
                    <div class="alert-banner warning">
                        <span class="icon">ü§ñ</span>
                        <div>
                            <strong>Vertex AI Enabled</strong>
                            <p>${summary.vertexAiProjects} project(s) have Vertex AI enabled. Monitor for AI usage costs.</p>
                        </div>
                    </div>
                `;
            }
            document.getElementById('gcp-alerts').innerHTML = alertsHtml;
        }

        function renderGcpProjects(data) {
            const projects = data.projects || [];

            document.getElementById('gcp-projects-table').innerHTML = projects.map(p => {
                const resources = [];
                if (p.vertexAi > 0) resources.push('<span class="badge badge-purple">Vertex AI</span>');
                if (p.storageBuckets > 0) resources.push(`<span class="badge badge-blue">${p.storageBuckets} Buckets</span>`);
                if (p.computeInstances > 0) resources.push(`<span class="badge badge-yellow">${p.computeInstances} VMs</span>`);
                if (p.cloudRun > 0) resources.push(`<span class="badge badge-green">${p.cloudRun} Cloud Run</span>`);
                if (p.gkeClusters > 0) resources.push(`<span class="badge badge-red">${p.gkeClusters} GKE</span>`);

                return `
                    <tr>
                        <td><strong>${p.name}</strong></td>
                        <td><code style="font-size: 12px; color: #71717a;">${p.projectId}</code></td>
                        <td><span class="badge ${p.billingEnabled ? 'badge-green' : 'badge-yellow'}">${p.billingEnabled ? 'Enabled' : 'Disabled'}</span></td>
                        <td>${p.enabledApis} APIs</td>
                        <td>${resources.join(' ') || '<span class="neutral">None</span>'}</td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="5" style="text-align: center;">No projects found</td></tr>';
        }

        function renderGcpChart(data) {
            const ctx = document.getElementById('gcpChart').getContext('2d');
            const summary = data.summary || {};

            if (gcpChart) gcpChart.destroy();

            gcpChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Projects', 'Vertex AI', 'Storage', 'Compute', 'Cloud Run', 'GKE', 'BigQuery'],
                    datasets: [{
                        label: 'Resource Count',
                        data: [
                            summary.totalProjects || 0,
                            summary.vertexAiProjects || 0,
                            summary.storageBuckets || 0,
                            summary.computeInstances || 0,
                            summary.cloudRunServices || 0,
                            summary.gkeClusters || 0,
                            summary.bigqueryDatasets || 0
                        ],
                        backgroundColor: [
                            'rgba(234, 67, 53, 0.6)',
                            'rgba(66, 133, 244, 0.6)',
                            'rgba(251, 188, 5, 0.6)',
                            'rgba(52, 168, 83, 0.6)',
                            'rgba(139, 92, 246, 0.6)',
                            'rgba(236, 72, 153, 0.6)',
                            'rgba(20, 184, 166, 0.6)'
                        ],
                        borderWidth: 0,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#71717a' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#71717a' }
                        }
                    }
                }
            });
        }

        async function loadData() {
            try {
                const response = await fetch('data.json?t=' + Date.now());
                const data = await response.json();

                document.getElementById('timestamp').textContent =
                    `Last updated: ${new Date(data.timestamp).toLocaleString()} | ${data.subscription?.name || 'Unknown'}`;

                renderSponsorshipBanner(data);
                renderAlerts(data);
                renderSummaryCards(data);
                renderCostChart(data);
                renderAccountChart(data);
                renderAccountsTable(data);
                renderAiServicesTable(data);
                renderResourcesTable(data);
                renderInvoicesTable(data);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('summary-cards').innerHTML = `
                    <div class="card" style="grid-column: 1/-1; text-align: center;">
                        <p style="color: #f87171;">Error loading data. Run <code>./collect-data.sh</code> first.</p>
                    </div>
                `;
            }
        }

        async function refreshData() {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            btn.textContent = 'Refreshing...';

            try {
                // In a real setup, this would call the backend to refresh data
                // For now, just reload the JSON
                await loadData();
                scheduleNextRefresh();
            } finally {
                btn.disabled = false;
                btn.textContent = 'Refresh Now';
            }
        }

        function scheduleNextRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);

            nextRefreshTime = Date.now() + REFRESH_INTERVAL;

            // Update countdown every second
            setInterval(updateNextRefreshDisplay, 1000);

            // Refresh data every hour
            refreshInterval = setInterval(async () => {
                await loadData();
                nextRefreshTime = Date.now() + REFRESH_INTERVAL;
            }, REFRESH_INTERVAL);
        }

        // Initialize
        loadData();
        scheduleNextRefresh();
    </script>
</body>
</html>
